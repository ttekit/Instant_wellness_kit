generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  surname   String
  email     String    @unique
  password  String
  createdAt DateTime  @default(now())
  roleId    Int       @map("role_id")
  billings  Billing[]
  orders    Order[]
  role      Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Billing {
  id            Int               @id @default(autoincrement())
  userId        Int               @map("user_id")
  paymentMethod PaymentMethodType @map("payment_method")
  details       Json
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("billing")
}

model Order {
  id                 Int                   @id @default(autoincrement())
  subtotal           Decimal
  composite_tax_rate Decimal               @map("composite_tax_rate")
  tax_amount         Decimal               @map("tax_amount")
  total_amount       Decimal               @map("total_amount")
  timestamp          DateTime              @default(now())
  created_at         DateTime              @default(now()) @map("created_at")
  updated_at         DateTime              @updatedAt @map("updated_at")
  userId             Int                   @map("user_id")
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  jurisdictions      OrderOnJurisdiction[]
  status             Status                @default(PENDING)
  packageId          Int                   @map("package_id")
  package            ProductPackage        @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@map("order")
}

model Jurisdiction {
  id       Int    @id @default(autoincrement())
  name     String
  type     String
  fipsCode String @map("fipsCode")

  minLat  Float?
  maxLat  Float?
  minLong Float?
  maxLong Float?

  orders    OrderOnJurisdiction[]
  tax_rates TaxRate[]
  products  Product[]
}

model OrderOnJurisdiction {
  order_id        Int          @map("order_id")
  jurisdiction_id Int          @map("jurisdiction_id")
  jurisdiction    Jurisdiction @relation(fields: [jurisdiction_id], references: [id], onDelete: Cascade)
  order           Order        @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@id([order_id, jurisdiction_id])
  @@map("order_on_jurisdiction")
}

model TaxRate {
  id              Int          @id @default(autoincrement())
  rate            Decimal      @map("rate")
  local_rate      Decimal      @map("local_rate")
  mctd            Decimal?
  composite       Decimal?
  type            Decimal?
  created_at      DateTime     @default(now()) @map("created_at")
  updated_at      DateTime     @updatedAt @map("updated_at")
  jurisdiction_id Int          @map("jurisdiction_id")
  jurisdiction    Jurisdiction @relation(fields: [jurisdiction_id], references: [id], onDelete: Cascade)

  @@map("tax_rates")
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  permissions Json
  users       User[]

  @@map("roles")
}

model ProductPackage {
  id          Int                @id @default(autoincrement())
  package     String
  description String
  img_link    String
  price       Decimal
  status      Status             @default(PENDING)
  taxRate     Decimal            @map("tax_rate")
  products    ProductOnPackage[]

  orders Order[]

  @@map("products_packegs")
}

model Product {
  id      Int     @id @default(autoincrement())
  product String
  price   Decimal
  status  Status  @default(PENDING)

  packages      ProductOnPackage[]
  jurisdictions Jurisdiction[]

  @@map("products")
}

model ProductOnPackage {
  productId Int @map("product_id")
  packageId Int @map("package_id")

  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  package ProductPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@id([productId, packageId])
  @@map("product_on_package")
}

enum PaymentMethodType {
  CREDIT_CARD
  PAYPAL
  BANK_TRANSFER
}

enum Status {
  ARRIVED
  DELIVERING
  PENDING
  BLOCKED
}
